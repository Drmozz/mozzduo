<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Mozzduo</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      color: orange;
    }
    .box {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 16px;
      font-size: 16px;
    }
    button {
      background-color: orange;
      border: none;
      color: black;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      width: 100%;
      margin-top: 8px;
    }
    button:hover {
      background-color: darkorange;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, serverTimestamp, getDocs, collection, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAO0LdsUQ05XRz3wLyTI6VD4r73qHKd1lU",
      authDomain: "mozzduo-f4988.firebaseapp.com",
      projectId: "mozzduo-f4988",
      storageBucket: "mozzduo-f4988.firebasestorage.app",
      messagingSenderId: "907165414498",
      appId: "1:907165414498:web:950a1962b3bad8c7e14d3b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let currentEvent = null;

async function resizeImageWithDialog(file) {
  const maxSizeKB = parseInt(prompt("Taille max de l‚Äôimage en Ko (ex: 200 pour 200 Ko)", "200"));
  if (!maxSizeKB || isNaN(maxSizeKB)) return file;

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        let width = img.width;
        let height = img.height;

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);

        const targetSize = maxSizeKB * 1024;
        let quality = 0.92;

        function attemptCompress() {
          canvas.toBlob(blob => {
            if (blob.size <= targetSize || quality <= 0.1) {
              resolve(blob);
            } else {
              quality -= 0.05;
              attemptCompress();
            }
          }, file.type, quality);
        }

        attemptCompress();
      };
      img.onerror = () => reject("Erreur de chargement de l‚Äôimage.");
      img.src = e.target.result;
    };
    reader.onerror = () => reject("Erreur FileReader.");
    reader.readAsDataURL(file);
  });
}

    let editIndex = null;

    async function loadEvents() {
      const eventList = document.getElementById("event-select");
      eventList.innerHTML = "";
      const snap = await getDocs(collection(db, "events"));
      const option = document.createElement("option");
      option.textContent = "-- S√©lectionner --";
      option.disabled = true;
      option.selected = true;
      eventList.appendChild(option);
      snap.forEach(doc => {
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = doc.id;
        eventList.appendChild(opt);
      });
    }

    async function loadSteps(eventId) {
      const container = document.getElementById("steps-container");
      container.innerHTML = "";
      const docRef = doc(db, "events", eventId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const steps = data.steps || [];
      if (steps.length === 0) {
        container.innerHTML = "<p>Aucune √©tape enregistr√©e pour ce projet.</p>";
        return;
      }
      
  
  steps.forEach((step, index) => {
    const div = document.createElement("div");
    div.style.border = "1px solid #444";
    div.style.marginBottom = "20px";
    div.style.padding = "10px";
    div.style.borderRadius = "6px";

    div.innerHTML = `
      <h4>√âtape ${index + 1}</h4>
      <div style="display: flex; gap: 20px;">
        <div>
          ${step.imgA ? `<img src="${step.imgA}" alt="imgA" style="max-width: 120px;" />` : "<p>Image A manquante</p>"}
          <p>Son A : ${step.soundA ? step.soundA.match(/[^\/]*$/)[0] : "‚Äî"}<br/>Mode A : ${step.scrollA ? "scroll" : "fit"}</p>
        </div>
        <div>
          ${step.imgB ? `<img src="${step.imgB}" alt="imgB" style="max-width: 120px;" />` : "<p>Image B manquante</p>"}
          <p>Son B : ${step.soundB ? step.soundB.match(/[^\/]*$/)[0] : "‚Äî"}<br/>Mode B : ${step.scrollB ? "scroll" : "fit"}</p>
        </div>
      </div>
      ${step.redirect ? `<p>üîó Redirection : <a href="${step.redirect}" target="_blank">${step.redirect}</a></p>` : ""}
      <button class="edit-step" data-index="${index}">‚úèÔ∏è Modifier</button>
      <button class="delete-step" data-index="${index}" style="background-color: crimson; margin-top: 10px;">üóë Supprimer</button>
      ${index > 0 ? `<button class="move-up" data-index="${index}" style="margin-top: 5px;">‚¨ÜÔ∏è Monter</button>` : ""}
      ${index < steps.length - 1 ? `<button class="move-down" data-index="${index}" style="margin-left: 5px;">‚¨áÔ∏è Descendre</button>` : ""}
    `;
    container.appendChild(div);
  });

  document.querySelectorAll(".edit-step").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const index = parseInt(e.target.dataset.index);
      editIndex = index;
      const docRef = doc(db, "events", currentEvent);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const step = docSnap.data().steps[index];
      document.getElementById("redirect").value = step.redirect || "";
          document.getElementById("scrollA").checked = !!step.scrollA;
          document.getElementById("scrollB").checked = !!step.scrollB;
      const setSelectByUrl = (selectId, url) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        [...select.options].forEach(opt => {
          if (opt.value === url) select.value = url;
        });
      };
      setSelectByUrl("imgA-select", step.imgA);
      setSelectByUrl("imgB-select", step.imgB);
      setSelectByUrl("soundA-select", step.soundA);
      setSelectByUrl("soundB-select", step.soundB);
      window.scrollTo(0, document.getElementById("step-form").offsetTop);
    });
  });

  document.querySelectorAll(".delete-step").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const index = parseInt(e.target.dataset.index);
      if (!confirm("Supprimer cette √©tape ?")) return;
      const docRef = doc(db, "events", currentEvent);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const steps = data.steps || [];
      steps.splice(index, 1);
      await updateDoc(docRef, { steps });
      alert("√âtape supprim√©e.");
      loadSteps(currentEvent);
    });
  });

  document.querySelectorAll(".move-up").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const index = parseInt(e.target.dataset.index);
      if (index === 0) return;
      const docRef = doc(db, "events", currentEvent);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const steps = data.steps || [];
      [steps[index - 1], steps[index]] = [steps[index], steps[index - 1]];
      await updateDoc(docRef, { steps });
      loadSteps(currentEvent);
    });
  });

  document.querySelectorAll(".move-down").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const index = parseInt(e.target.dataset.index);
      const docRef = doc(db, "events", currentEvent);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const steps = data.steps || [];
      if (index >= steps.length - 1) return;
      [steps[index], steps[index + 1]] = [steps[index + 1], steps[index]];
      await updateDoc(docRef, { steps });
      loadSteps(currentEvent);
    });
  });


  document.querySelectorAll(".edit-step").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const index = parseInt(e.target.dataset.index);
      editIndex = index;
      const docRef = doc(db, "events", currentEvent);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const step = docSnap.data().steps[index];
      document.getElementById("redirect").value = step.redirect || "";
          document.getElementById("scrollA").checked = !!step.scrollA;
          document.getElementById("scrollB").checked = !!step.scrollB;
      const setSelectByUrl = (selectId, url) => {
        const select = document.getElementById(selectId);
        if (!select) return;
        [...select.options].forEach(opt => {
          if (opt.value === url) select.value = url;
        });
      };
      setSelectByUrl("imgA-select", step.imgA);
      setSelectByUrl("imgB-select", step.imgB);
      setSelectByUrl("soundA-select", step.soundA);
      setSelectByUrl("soundB-select", step.soundB);
      window.scrollTo(0, document.getElementById("step-form").offsetTop);
    });
  });

  document.querySelectorAll(".delete-step").forEach(btn => {
    btn.addEventListener("click", async (e) => {
      const index = parseInt(e.target.dataset.index);
      if (!confirm("Supprimer cette √©tape ?")) return;
      const docRef = doc(db, "events", currentEvent);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) return;
      const data = docSnap.data();
      const steps = data.steps || [];
      steps.splice(index, 1);
      await updateDoc(docRef, { steps });
      alert("√âtape supprim√©e.");
      loadSteps(currentEvent);
    });
  });


      document.querySelectorAll(".edit-step").forEach(btn => {
        btn.addEventListener("click", async (e) => {
          const index = parseInt(e.target.dataset.index);
          editIndex = index;
          const docRef = doc(db, "events", currentEvent);
          const docSnap = await getDoc(docRef);
          if (!docSnap.exists()) return;
          const step = docSnap.data().steps[index];
          document.getElementById("redirect").value = step.redirect || "";
          document.getElementById("scrollA").checked = !!step.scrollA;
          document.getElementById("scrollB").checked = !!step.scrollB;
          const setSelectByUrl = (selectId, url) => {
            const select = document.getElementById(selectId);
            if (!select) return;
            [...select.options].forEach(opt => {
              if (opt.value === url) select.value = url;
            });
          };
          setSelectByUrl("imgA-select", step.imgA);
          setSelectByUrl("imgB-select", step.imgB);
          setSelectByUrl("soundA-select", step.soundA);
          setSelectByUrl("soundB-select", step.soundB);
          window.scrollTo(0, document.getElementById("step-form").offsetTop);
        });
      });
    }

    async function populateFileSelectors() {
      const folderRef = storageRef(storage, `events/${currentEvent}/`);
      try {
        const listResult = await listAll(folderRef);
        const options = await Promise.all(listResult.items.map(async (item) => {
          const url = await getDownloadURL(item);
          return { name: item.name, url };
        }));
        const populate = (selectId) => {
          const select = document.getElementById(selectId);
          select.innerHTML = '<option value="">-- Ou choisir un fichier existant --</option>';
          options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.url;
            option.textContent = opt.name;
            select.appendChild(option);
          });
        };
        populate("imgA-select");
        populate("imgB-select");
        populate("soundA-select");
        populate("soundB-select");
      } catch (err) {
        console.error("Erreur lors du chargement des fichiers :", err);
      }
    }

    
    window.saveLatence = async function () {
  if (!currentEvent) {
    alert("Veuillez s√©lectionner un projet avant de modifier la latence.");
    return;
  }
  const val = parseInt(document.getElementById("latenceMs").value, 10);
  if (!currentEvent || isNaN(val)) {
    alert("Veuillez s√©lectionner un projet et entrer une valeur valide.");
    return;
  }

window.saveLatenceRouge = async function () {
  if (!currentEvent) {
    alert("Veuillez s√©lectionner un projet avant de modifier le d√©lai rouge.");
    return;
  }
  const val = parseInt(document.getElementById("latenceRougeMs").value, 10);
  if (!currentEvent || isNaN(val)) {
    alert("Veuillez s√©lectionner un projet et entrer une valeur valide.");
    return;
  }


      const val = parseInt(document.getElementById("latenceMs").value, 10);
      if (!currentEvent || isNaN(val)) {
        alert("Veuillez s√©lectionner un projet et entrer une valeur valide.");
      }


    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("event-form");
      const eventList = document.getElementById("event-select");
      const stepEditor = document.getElementById("step-editor");
      const stepForm = document.getElementById("step-form");

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const eventId = document.getElementById("event-id").value.trim();
        if (!eventId) return alert("Veuillez saisir un ID de projet.");
        try {
          await setDoc(doc(db, "events", eventId), {
            title: "Projet " + eventId,
            createdAt: serverTimestamp(),
            steps: []
          });
          alert(`Projet "${eventId}" cr√©√© avec succ√®s.`);
          form.reset();
          loadEvents();
        } catch (error) {
          console.error("Erreur lors de la cr√©ation :", error);
          alert("Erreur lors de la cr√©ation du projet.");
        }
      });

      eventList.addEventListener("change", async (e) => {
        document.getElementById("btn-latence").disabled = false;
        document.getElementById("btn-latence-rouge").disabled = false;
        currentEvent = e.target.value;
        stepEditor.style.display = "block";

        const docRef = doc(db, "events", currentEvent);
        const docSnap = await getDoc(docRef);
        const data = docSnap.exists() ? docSnap.data() : {};
        const val = data.latenceMs !== undefined ? data.latenceMs : 3000;
        const rouge = data.latenceRougeMs !== undefined ? data.latenceRougeMs : 500;
        document.getElementById("latenceRougeMs").value = rouge;
        document.getElementById("latenceMs").value = val !== undefined ? val : 3000;
        populateFileSelectors();
        loadSteps(currentEvent);
      });

      stepForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentEvent) return alert("Aucun projet s√©lectionn√©.");
        const imgA = document.getElementById("imgA").files[0];
        const imgB = document.getElementById("imgB").files[0];
        const soundA = document.getElementById("soundA").files[0];
        const soundB = document.getElementById("soundB").files[0];
        const redirect = document.getElementById("redirect").value;
        const scrollA = document.getElementById("scrollA").checked;
        const scrollB = document.getElementById("scrollB").checked;
        const imgA_select = document.getElementById("imgA-select").value;
        const imgB_select = document.getElementById("imgB-select").value;
        const soundA_select = document.getElementById("soundA-select").value;
        const soundB_select = document.getElementById("soundB-select").value;
        const storageBase = `events/${currentEvent}/`;

        
const uploadOrUseExisting = async (file, existingUrl) => {
  if (existingUrl) return existingUrl;
  if (!file) return null;
  const path = storageBase + Date.now() + "_" + file.name;
  const ref = storageRef(storage, path);
  const toUpload = file.type.startsWith("image/")
    ? await resizeImageWithDialog(file)
    : file;
  await uploadBytes(ref, toUpload);
  return getDownloadURL(ref);
};


        try {
          const [imgAUrl, imgBUrl, soundAUrl, soundBUrl] = await Promise.all([
            uploadOrUseExisting(imgA, imgA_select),
            uploadOrUseExisting(imgB, imgB_select),
            uploadOrUseExisting(soundA, soundA_select),
            uploadOrUseExisting(soundB, soundB_select)
          ]);
console.log('URLs upload√©es :', { imgAUrl, imgBUrl, soundAUrl, soundBUrl });
          const docRef = doc(db, "events", currentEvent);
          const docSnap = await getDoc(docRef);
          const data = docSnap.exists() ? docSnap.data() : { steps: [] };
          const steps = data.steps || [];
          const newStep = {
            imgA: imgAUrl,
            imgB: imgBUrl,
            soundA: soundAUrl,
            soundB: soundBUrl,
            redirect: redirect || "",
            scrollA,
            scrollB
          };
          if (editIndex !== null) {
            steps[editIndex] = newStep;
            editIndex = null;
            alert("√âtape modifi√©e avec succ√®s !");
          } else {
            steps.push(newStep);
            alert("√âtape ajout√©e avec succ√®s !");
          }
          await updateDoc(docRef, { steps });
          stepForm.reset();
          loadSteps(currentEvent);
        } catch (err) {
          console.error("Erreur lors de la soumission :", err);
          alert("Erreur lors de la soumission.");
        }
      });

      loadEvents();
    });
  
    window.saveDotColors = async function () {
      const color1 = document.getElementById("dotColor1").value;
      const color2 = document.getElementById("dotColor2").value;
      if (!currentEvent) return alert("Veuillez s√©lectionner un projet.");
</script>
</head>
<body>
  <h1>üé© Admin Mozzduo</h1>
  <div class="box">
    <h2>üèóÔ∏è Cr√©ation d'un projet</h2>
    <form id="event-form">
      <label for="event-id">Event ID :</label><br/><br/><br/>
      <input type="text" id="event-id" placeholder="ex: MAGIE2025" required />
      <button type="submit">+ Cr√©er un nouveau projet</button>
    </form>

    <h2>üìÇ Ou choisir un projet existant :</h2>
    <select id="event-select"></select>

    <label for="latenceMs">‚è±Ô∏è Latence (ms avant changement) :</label>
    <input type="number" id="latenceMs" value="3000" />
    <button id="btn-latence" onclick="saveLatence()" disabled>üíæ Enregistrer la latence</button>

    
    <label for="latenceRougeMs">‚è±Ô∏è D√©lai avant passage au rouge (ms) :</label>
    <input type="number" id="latenceRougeMs" value="500" />
    <button id="btn-latence-rouge" onclick="saveLatenceRouge()" disabled>üíæ Enregistrer le d√©lai rouge</button>


    <label for="dotColor1">üé® Couleur 1 (√† la r√©ception du trigger) :</label>
    <input type="color" id="dotColor1" value="#0000ff" />
    
    <label for="dotColor2">üé® Couleur 2 (juste avant d√©clenchement) :</label>
    <input type="color" id="dotColor2" value="#ff0000" />
    
    <button onclick="saveDotColors()">üíæ Enregistrer les couleurs du point</button>


    <div id="step-editor" style="margin-top: 30px; display:none;">
      <h2>üß© Ajouter une √©tape</h2>
      <form id="step-form">
        <label>Image t√©l√©phone A :</label><br/><br/><br/>
        <select id="imgA-select"><option value="">-- Ou choisir un fichier existant --</option></select>
        <input type="file" id="imgA" accept="image/*" />
        <label style="display:inline-flex; align-items:center; gap:6px;">scroll <input type="checkbox" id="scrollA" /></label><br/><br/><br/>
        <label>Image t√©l√©phone B :</label><br/><br/><br/>
        <select id="imgB-select"><option value="">-- Ou choisir un fichier existant --</option></select>
        <input type="file" id="imgB" accept="image/*" />
        <label style="display:inline-flex; align-items:center; gap:6px;">scroll <input type="checkbox" id="scrollB" /></label><br/><br/><br/>
        <label>Son t√©l√©phone A :</label><br/><br/><br/>
        <select id="soundA-select"><option value="">-- Ou choisir un fichier existant --</option></select>
        <input type="file" id="soundA" accept="audio/*" />
        <label>Son t√©l√©phone B :</label><br/><br/><br/>
        <select id="soundB-select"><option value="">-- Ou choisir un fichier existant --</option></select>
        <input type="file" id="soundB" accept="audio/*" />
        <label>URL de redirection (optionnelle) :</label><br/><br/><br/>
        <input type="url" id="redirect" placeholder="https://..." />
        <button type="submit">Ajouter l'√©tape</button>
      </form>
      <div id="step-list" style="margin-top: 30px;">
        <h2>üóÇÔ∏è √âtapes existantes :</h2>
        <div id="steps-container"></div>
      </div>
    </div>
  </div>
</body>
</html>